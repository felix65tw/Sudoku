<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•°ç‹¬æ¸¸æˆ</title>
    <style>
        /* CSSå˜é‡å®šä¹‰ï¼Œä¾¿äºä¸»é¢˜ç®¡ç†å’Œç»Ÿä¸€é£æ ¼ */
        :root {
            --bg-color: #f5f7fa;
            --card-bg: #ffffff;
            --text-color: #2c3e50;
            --text-secondary: #7f8c8d;
            --primary: #3498db;
            --primary-light: #5dade2;
            --success: #2ecc71;
            --success-light: #58d68d;
            --danger: #e74c3c;
            --warning: #f39c12;
            --highlight: #e8f4fd;
            --border: #bdc3c7;
            --shadow: rgba(0, 0, 0, 0.1);
            --disabled: #95a5a6;
        }

        /* å…¨å±€æ ·å¼é‡ç½® */
        * {
            box-sizing: border-box;
            touch-action: manipulation; /* ä¼˜åŒ–ç§»åŠ¨ç«¯è§¦æ‘¸ä½“éªŒ */
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤ç§»åŠ¨ç«¯ç‚¹å‡»é«˜äº® */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow: hidden; /* ç¦æ­¢é é¢æ»¾å‹• */
        }

        /* ä¸»å®¹å™¨ - é™åˆ¶æœ€å¤§å®½åº¦ä¸ºä¹å®«æ ¼å®½åº¦ */
        .game-container {
            width: 100%;
            max-width: 400px; /* é™åˆ¶æœ€å¤§å®½åº¦ä¸ºä¹å®«æ ¼å®½åº¦ */
            display: flex;
            flex-direction: column;
            gap: 6px; /* å‡å°é—´è· */
            overflow: hidden; /* é˜²æ­¢å®¹å™¨å…§æ»¾å‹• */
        }

        /* é¡¶éƒ¨æ§åˆ¶æ  - åŠŸèƒ½æŒ‰é’® */
        .controls-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        /* åŸºç¡€æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            min-width: 0;
            text-align: center;
        }

        .btn:active {
            transform: scale(0.95);
        }

        /* ä¸»è¦æŒ‰é’®æ ·å¼ - ç”¨äºæ–°æ¸¸æˆæŒ‰é’® */
        .btn-primary {
            background-color: var(--primary);
        }

        /* æ¬¡è¦æŒ‰é’®æ ·å¼ - ç”¨äºé»˜è®¤çŠ¶æ€çš„åŠŸèƒ½æŒ‰é’® */
        .btn-secondary {
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border);
        }

        /* å¼€å¯çŠ¶æ€æŒ‰é’®æ ·å¼ - ç”¨äºç¬”è®°å’ŒéŸ³æ•ˆå¼€å¯çŠ¶æ€ */
        .btn-on {
            background-color: var(--success);
            color: white;
        }

        /* çŠ¶æ€æ  - è®¡æ—¶å™¨å’Œç»Ÿè®¡ä¿¡æ¯ */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.7rem; /* ä¸ç¬”è®°å­—ä½“å¤§å°ç›¸åŒ */
            padding: 0; /* ç§»é™¤æ‰€æœ‰å†…è¾¹è· */
            margin: 0; /* ç§»é™¤æ‰€æœ‰å¤–è¾¹è· */
            line-height: 0.1; /* è¿›ä¸€æ­¥æœ€å°åŒ–è¡Œé«˜ï¼Œè¾¾åˆ°å‡ ä¹æ— è·ç¦» */
            margin-top: 15px; /* å¢åŠ ä¸ä¸Šæ–¹åŠŸèƒ½é”®çš„é—´è· */
        }

        .timer {
            font-weight: 700;
            font-family: monospace; /* ä½¿ç”¨ç­‰å®½å­—ä½“ï¼Œç¡®ä¿æ•°å­—å¯¹é½ */
            color: var(--primary);
        }

        .stats {
            display: flex;
            gap: 12px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-value {
            font-weight: 700;
            font-family: monospace; /* ä½¿ç”¨ç­‰å®½å­—ä½“ï¼Œç¡®ä¿æ•°å­—å¯¹é½ */
            min-width: 20px; /* é¢„ç•™ä¸¤ä½æ•°å­—ç©ºé—´ */
            text-align: center;
        }

        /* æ•°ç‹¬æ£‹ç›˜æ ·å¼ */
        #sudoku-board {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            width: 100%;
            aspect-ratio: 1;
            background-color: var(--border);
            border: 2px solid var(--border);
            gap: 1px;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 4px 8px var(--shadow);
        }

        /* æ•°ç‹¬å•å…ƒæ ¼æ ·å¼ */
        .cell {
            background-color: var(--card-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem; /* å¢å¤§ä¹å®«æ ¼å†…æ•°å­— */
            font-weight: 600;
            cursor: pointer;
            position: relative;
            user-select: none; /* é˜²æ­¢æ–‡æœ¬é€‰æ‹© */
        }

        /* åˆå§‹çº¿ç´¢æ•°å­—æ ·å¼ - æ‰€æœ‰æ•°å­—éƒ½ä½¿ç”¨è¿™ä¸ªé¢œè‰² */
        .cell.clue, .cell.filled {
            color: var(--primary);
            font-weight: 700;
        }

        /* 3x3å®«æ ¼è¾¹æ¡†å¢å¼º */
        .cell.border-right { border-right: 2px solid var(--border); } 
        .cell.border-bottom { border-bottom: 2px solid var(--border); } 

        /* é«˜äº®ç›¸å…³å•å…ƒæ ¼ï¼ˆåŒä¸€è¡Œã€åˆ—å’Œå®«æ ¼ï¼‰ */
        .cell.highlight-related { background-color: var(--highlight); } 
        /* é€‰ä¸­çš„å•å…ƒæ ¼é«˜äº® */
        .cell.selected { background-color: rgba(52, 152, 219, 0.2) !important; } 
        /* ç›¸åŒæ•°å­—é«˜äº® */
        .cell.highlight-same { background-color: rgba(52, 152, 219, 0.3) !important; }
        /* é”™è¯¯æ•°å­—æ ·å¼ */
        .cell.error { color: var(--danger); }

        /* ç¬”è®°ç½‘æ ¼æ ·å¼ - ç”¨äºæ˜¾ç¤ºå€™é€‰æ•°å­— */
        .notes-grid {
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            grid-template-rows: repeat(3, 1fr);
            pointer-events: none; /* é˜²æ­¢ç¬”è®°ç½‘æ ¼å¹²æ‰°å•å…ƒæ ¼ç‚¹å‡» */
            padding: 1px;
        }

        /* å•ä¸ªç¬”è®°æ•°å­—æ ·å¼ */
        .note-num {
            font-size: 0.7rem; /* ç¬”è®°å­—ä½“ */
            color: var(--text-secondary); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            line-height: 1;
            font-weight: 500;
        }

        /* é«˜äº®ç¬”è®°ä¸­çš„ç›¸åŒæ•°å­— */
        .note-num.highlighted {
            background-color: var(--primary-light);
            color: white;
            border-radius: 2px;
            font-weight: 600;
        }

        /* æ•°å­—é”®ç›˜æ ·å¼ */
        .keypad {
            display: flex;
            gap: 6px;
            width: 100%;
        }

        /* æ•°å­—æŒ‰é’®æ ·å¼ */
        .numpad-btn {
            flex: 1;
            aspect-ratio: 1;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .numpad-btn:active {
            transform: scale(0.95);
        }

        .numpad-btn .num {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .numpad-btn .count {
            font-size: 0.6rem; /* å‡å°å­—ä½“ */
            color: var(--text-secondary);
            margin-top: 1px; /* å‡å°è¡Œè· */
            line-height: 1; /* å‡å°è¡Œè· */
        }

        /* å·²å®Œæˆçš„æ•°å­—æŒ‰é’®å˜æ·¡ */
        .numpad-btn.faded {
            opacity: 0.4;
        }

        /* å»ºè®®æ•°å­—çªå‡ºæ˜¾ç¤º */
        .numpad-btn.suggested {
            border: 2px solid var(--warning);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(243, 156, 18, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(243, 156, 18, 0); }
            100% { box-shadow: 0 0 0 0 rgba(243, 156, 18, 0); }
        }

        /* é®ç½©å±‚æ ·å¼ - ç”¨äºèƒœåˆ©ç•Œé¢ */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        /* æ¨¡æ€å¯¹è¯æ¡†æ ·å¼ */
        .modal {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            max-width: 90%;
            width: 300px;
        }

        .modal h2 {
            margin-top: 0;
            color: var(--primary);
        }

        .modal p {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        /* é”™è¯¯è¾“å…¥åŠ¨ç”» */
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            50% { transform: translateX(3px); }
            75% { transform: translateX(-3px); }
            100% { transform: translateX(0); }
        }

        .cell.error .main-num {
            animation: shake 0.4s ease-in-out;
        }

        /* æç¤ºåŠ¨ç”» */
        @keyframes text-flash {
            0%, 100% { color: var(--primary); transform: scale(1); }
            50% { color: #f39c12; transform: scale(1.2); }
        }

        .cell.hinting .main-num {
            animation: text-flash 0.6s ease-in-out 3;
        }

        /* å“åº”å¼è®¾è®¡ - é’ˆå¯¹å°å±å¹•è®¾å¤‡ä¼˜åŒ– */
        @media (max-width: 480px) {
            .controls-top {
                gap: 4px;
            }
            
            .btn {
                padding: 5px 8px;
                font-size: 0.8rem;
            }
            
            .cell {
                font-size: 1.4rem;
            }
            
            .numpad-btn .num {
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <!-- ä¸»å®¹å™¨ - é™åˆ¶æœ€å¤§å®½åº¦ä¸ºä¹å®«æ ¼å®½åº¦ -->
    <div class="game-container">
        <!-- é¡¶éƒ¨æ§åˆ¶æ  - åŠŸèƒ½æŒ‰é’® -->
        <div class="controls-top">
            <!-- éš¾æ˜“é€‰æ‹© -->
            <select class="btn btn-secondary" id="difficulty">
                <option value="Beginner">å…¥é–€</option>
                <option value="Easy" selected>ç°¡å–®</option>
                <option value="Medium">ä¸­ç­‰</option>
                <option value="Hard">å›°é›£</option>
                <option value="Expert">å°ˆå®¶</option>
            </select>
            
            <!-- æ–°æ¸¸æˆ -->
            <button class="btn btn-primary" id="btn-new-game">æ–°éŠæˆ²</button>
            
            <!-- ç¬”è®° -->
            <button class="btn btn-secondary" id="btn-notes">ç­†è¨˜</button>
            
            <!-- æç¤º -->
            <button class="btn btn-secondary" id="btn-hint">æç¤º</button>
            
            <!-- éŸ³æ•ˆ -->
            <button class="btn btn-on" id="btn-sound">éŸ³æ•ˆ</button>
        </div>
        
        <!-- çŠ¶æ€æ  - è®¡æ—¶å™¨å’Œç»Ÿè®¡ä¿¡æ¯ -->
        <div class="status-bar">
            <!-- è®¡æ—¶å™¨ -->
            <div class="timer" id="timer-display">00:00</div>
            
            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="stats">
                <div class="stat-item">
                    <span>éŒ¯èª¤:</span>
                    <span class="stat-value" id="error-stat">00</span>
                </div>
                <div class="stat-item">
                    <span>æç¤º:</span>
                    <span class="stat-value" id="hint-stat">00</span>
                </div>
            </div>
        </div>
        
        <!-- æ•°ç‹¬æ£‹ç›˜ -->
        <div id="sudoku-board"></div>
        
        <!-- æ•°å­—é”®ç›˜ -->
        <div class="keypad" id="keypad"></div>
    </div>

    <!-- èƒœåˆ©ç•Œé¢é®ç½© -->
    <div class="overlay" id="victory-overlay">
        <div class="modal">
            <h2>ğŸ‰ æ­å–œå®Œæˆï¼</h2>
            <p id="victory-time-text">è€—æ™‚ï¼š00:00</p>
            <p id="victory-stats">éŒ¯èª¤: 00, æç¤º: 00</p>
            <button class="btn btn-primary" onclick="closeOverlay()">ç¢ºå®š</button>
        </div>
    </div>

    <script>
        // ======================================================================
        // éŠæˆ²ç‹€æ…‹è®Šæ•¸å®šç¾©
        // ======================================================================

        // æ•¸ç¨ç›¸é—œæ•¸æ“š
        let board = [];          // ç•¶å‰éŠæˆ²ç›¤é¢ï¼ˆåŒ…å«ç©å®¶è¼¸å…¥çš„æ•¸å­—ï¼‰
        let solution = [];       // å®Œæ•´è§£ç­”
        let initial = [];        // åˆå§‹ç›¤é¢ï¼ˆåªåŒ…å«é è¨­çš„ç·šç´¢æ•¸å­—ï¼‰
        let selectedCell = null; // ç•¶å‰é¸ä¸­çš„å–®å…ƒæ ¼åº§æ¨™ {r, c}

        // éŠæˆ²åŠŸèƒ½ç‹€æ…‹
        let notesEnabled = false; // ç­†è¨˜æ¨¡å¼æ˜¯å¦å•Ÿç”¨
        let soundEnabled = true;  // éŸ³æ•ˆæ˜¯å¦å•Ÿç”¨
        let gameOver = false;     // éŠæˆ²æ˜¯å¦çµæŸ
        let isPaused = false;     // éŠæˆ²æ˜¯å¦æš«åœ

        // æ•¸å­—çµ±è¨ˆ
        let counts = Array(10).fill(9); // æ¯å€‹æ•¸å­—é‚„éœ€è¦å¡«å¯«çš„æ•¸é‡ï¼ˆç´¢å¼•1-9å°æ‡‰æ•¸å­—1-9ï¼‰

        // è¨ˆæ™‚å™¨ç›¸é—œ
        let timerInterval = null; // è¨ˆæ™‚å™¨é–“éš”ID
        let timeElapsed = 0;      // å·²è€—è²»çš„æ™‚é–“ï¼ˆç§’ï¼‰

        // éŠæˆ²çµ±è¨ˆ
        let errorCount = 0; // éŒ¯èª¤æ¬¡æ•¸
        let hintCount = 0;  // æç¤ºä½¿ç”¨æ¬¡æ•¸

        // ======================================================================
        // éŸ³æ•ˆç³»çµ±
        // ======================================================================

        // ä½¿ç”¨Web Audio APIå‰µå»ºéŸ³æ•ˆä¸Šä¸‹æ–‡
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;

        /**
         * åˆå§‹åŒ–éŸ³é »ä¸Šä¸‹æ–‡
         * ç”±æ–¼ç€è¦½å™¨è‡ªå‹•æ’­æ”¾ç­–ç•¥ï¼Œéœ€è¦åœ¨ç”¨æˆ¶äº¤äº’å¾Œæ‰èƒ½å‰µå»ºéŸ³é »ä¸Šä¸‹æ–‡
         */
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new AudioContext();
            }
        }

        /**
         * æ’­æ”¾æŒ‡å®šé¡å‹çš„éŸ³æ•ˆ
         * @param {string} type - éŸ³æ•ˆé¡å‹ï¼š'correct', 'error', 'hint', 'ui', 'win'
         * æ¯ç¨®éŸ³æ•ˆä½¿ç”¨ä¸åŒçš„æŒ¯ç›ªå™¨é¡å‹å’Œé »ç‡ä¾†ç”¢ç”Ÿä¸åŒçš„è²éŸ³æ•ˆæœ
         */
        function playSound(type) {
            // å¦‚æœéŸ³æ•ˆé—œé–‰ï¼Œç›´æ¥è¿”å›
            if (!soundEnabled) return;
            
            // ç¢ºä¿éŸ³é »ä¸Šä¸‹æ–‡å·²åˆå§‹åŒ–
            if (!audioCtx) initAudio();
            
            // å¦‚æœéŸ³é »ä¸Šä¸‹æ–‡è¢«æš«åœï¼Œæ¢å¾©å®ƒï¼ˆç€è¦½å™¨è‡ªå‹•æ’­æ”¾ç­–ç•¥ï¼‰
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            // æ ¹æ“šä¸åŒéŸ³æ•ˆé¡å‹è¨­ç½®ä¸åŒçš„éŸ³é »åƒæ•¸
            switch (type) {
                case 'correct': // æ­£ç¢ºç­”æ¡ˆéŸ³æ•ˆ - ç°¡çŸ­çš„é«˜é »éŸ³
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(1000, now);
                    gainNode.gain.setValueAtTime(0.3, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now);
                    osc.stop(now + 0.1);
                    break;
                case 'error': // éŒ¯èª¤ç­”æ¡ˆéŸ³æ•ˆ - ä½æ²‰çš„ä¸‹é™éŸ³
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.linearRampToValueAtTime(100, now + 0.3);
                    gainNode.gain.setValueAtTime(0.2, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                    osc.start(now);
                    osc.stop(now + 0.3);
                    break;
                case 'hint': // æç¤ºéŸ³æ•ˆ - ä¸Šå‡çš„ä¸‰è§’æ³¢
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(300, now);
                    osc.frequency.linearRampToValueAtTime(800, now + 0.3);
                    gainNode.gain.setValueAtTime(0.1, now);
                    gainNode.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.start(now);
                    osc.stop(now + 0.3);
                    break;
                case 'ui': // UIäº¤äº’éŸ³æ•ˆ - çŸ­ä¿ƒçš„æ–¹æ³¢
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(800, now);
                    gainNode.gain.setValueAtTime(0.05, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                    osc.start(now);
                    osc.stop(now + 0.05);
                    break;
                case 'win': // å‹åˆ©éŸ³æ•ˆ - ä¸‰å€‹éŸ³ç¬¦çš„çµ„åˆ
                    playNote(523.25, now, 0.2); // C5
                    playNote(659.25, now + 0.15, 0.2); // E5
                    playNote(783.99, now + 0.3, 0.4); // G5
                    break;
            }
        }

        /**
         * æ’­æ”¾å–®å€‹éŸ³ç¬¦
         * @param {number} freq - é »ç‡ï¼ˆHzï¼‰
         * @param {number} time - é–‹å§‹æ™‚é–“
         * @param {number} duration - æŒçºŒæ™‚é–“ï¼ˆç§’ï¼‰
         */
        function playNote(freq, time, duration) {
            if (!audioCtx) initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(freq, time);
            gain.gain.setValueAtTime(0.1, time);
            gain.gain.exponentialRampToValueAtTime(0.01, time + duration);
            osc.start(time);
            osc.stop(time + duration);
        }

        // ======================================================================
        // åˆå§‹åŒ–èˆ‡äº‹ä»¶ç›£è½è¨­ç½®
        // ======================================================================

        /**
         * DOMå…§å®¹åŠ è¼‰å®Œæˆå¾Œåˆå§‹åŒ–éŠæˆ²
         * é€™æ˜¯æ•´å€‹éŠæˆ²çš„å…¥å£é»ï¼Œè¨­ç½®äº†æ‰€æœ‰å¿…è¦çš„åˆå§‹ç‹€æ…‹
         */
        document.addEventListener('DOMContentLoaded', () => {
            createBoardHTML(); // å‰µå»ºæ•¸ç¨æ£‹ç›¤HTMLçµæ§‹
            createKeypadHTML(); // å‰µå»ºæ•¸å­—éµç›¤HTMLçµæ§‹
            startNewGame(); // é–‹å§‹æ–°éŠæˆ²
            setupEventListeners(); // è¨­ç½®äº‹ä»¶ç›£è½å™¨
        });

        /**
         * è¨­ç½®æ‰€æœ‰äº‹ä»¶ç›£è½å™¨
         * ç‚ºæ‰€æœ‰ç”¨æˆ¶äº¤äº’å…ƒç´ ç¶å®šå°æ‡‰çš„äº‹ä»¶è™•ç†å‡½æ•¸
         */
        function setupEventListeners() {
            // æ–°éŠæˆ²æŒ‰éˆ• - é»æ“Šæ™‚é–‹å§‹æ–°éŠæˆ²
            document.getElementById('btn-new-game').addEventListener('click', () => {
                playSound('ui');
                startNewGame();
            });
            
            // ç­†è¨˜æ¨¡å¼åˆ‡æ›æŒ‰éˆ• - é»æ“Šæ™‚åˆ‡æ›ç­†è¨˜æ¨¡å¼
            document.getElementById('btn-notes').addEventListener('click', () => {
                playSound('ui');
                toggleNotes();
            });
            
            // æç¤ºæŒ‰éˆ• - é»æ“Šæ™‚ä½¿ç”¨æç¤ºåŠŸèƒ½
            document.getElementById('btn-hint').addEventListener('click', () => {
                useHint();
            });
            
            // éŸ³æ•ˆåˆ‡æ›æŒ‰éˆ• - é»æ“Šæ™‚åˆ‡æ›éŸ³æ•ˆé–‹é—œ
            document.getElementById('btn-sound').addEventListener('click', () => {
                playSound('ui');
                toggleSound();
            });
            
            // é›£åº¦é¸æ“‡ä¸‹æ‹‰èœå–® - æ”¹è®Šæ™‚é–‹å§‹æ–°éŠæˆ²
            document.getElementById('difficulty').addEventListener('change', () => {
                playSound('ui');
                startNewGame();
            });
        }

        // ======================================================================
        // éŠæˆ²æ ¸å¿ƒåŠŸèƒ½
        // ======================================================================

        /**
         * é–‹å§‹æ–°éŠæˆ²
         * é‡ç½®æ‰€æœ‰éŠæˆ²ç‹€æ…‹ä¸¦ç”Ÿæˆæ–°çš„æ•¸ç¨è¬é¡Œ
         */
        function startNewGame() {
            // å¦‚æœéŠæˆ²æš«åœï¼Œå…ˆå–æ¶ˆæš«åœ
            if (isPaused) togglePause();
            
            // ç²å–é¸ä¸­çš„é›£åº¦
            const diff = document.getElementById('difficulty').value;
            
            // ç”Ÿæˆæ–°çš„æ•¸ç¨éŠæˆ²
            generateSudoku(diff);
            
            // é‡ç½®éŠæˆ²ç‹€æ…‹
            gameOver = false;
            selectedCell = null;
            errorCount = 0;
            hintCount = 0;
            
            // æ›´æ–°UI
            updateStats();
            updateBoardUI();
            updateCounts();
            updateHighlighting();
            
            // é–‹å§‹è¨ˆæ™‚
            startTimer();
        }

        /**
         * å‰µå»ºæ•¸ç¨æ£‹ç›¤çš„HTMLçµæ§‹
         * ä½¿ç”¨9x9ç¶²æ ¼ä½ˆå±€ï¼Œä¸¦æ·»åŠ 3x3å®®æ ¼çš„ç²—é‚Šæ¡†
         * æ¯å€‹å–®å…ƒæ ¼åŒ…å«ä¸»æ•¸å­—é¡¯ç¤ºå€åŸŸå’Œç­†è¨˜ç¶²æ ¼
         */
        function createBoardHTML() {
            const boardEl = document.getElementById('sudoku-board');
            boardEl.innerHTML = ''; // æ¸…ç©ºç¾æœ‰å…§å®¹
            
            // å‰µå»º9x9ç¶²æ ¼
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.r = r; // å­˜å„²è¡Œç´¢å¼•ï¼Œç”¨æ–¼å¾ŒçºŒè­˜åˆ¥å–®å…ƒæ ¼ä½ç½®
                    cell.dataset.c = c; // å­˜å„²åˆ—ç´¢å¼•ï¼Œç”¨æ–¼å¾ŒçºŒè­˜åˆ¥å–®å…ƒæ ¼ä½ç½®
                    
                    // æ·»åŠ 3x3å®®æ ¼çš„ç²—é‚Šæ¡†ï¼Œå¢å¼·è¦–è¦ºçµæ§‹
                    if ((c + 1) % 3 === 0 && c !== 8) cell.classList.add('border-right');
                    if ((r + 1) % 3 === 0 && r !== 8) cell.classList.add('border-bottom');
                    
                    // å‰µå»ºç­†è¨˜ç¶²æ ¼ï¼ˆç”¨æ–¼é¡¯ç¤ºå€™é¸æ•¸å­—ï¼‰
                    const notesDiv = document.createElement('div');
                    notesDiv.className = 'notes-grid';
                    for(let i = 1; i <= 9; i++) {
                        const note = document.createElement('div');
                        note.className = 'note-num';
                        note.dataset.num = i; // å­˜å„²æ•¸å­—å€¼ï¼Œç”¨æ–¼å¾ŒçºŒè­˜åˆ¥å’Œæ“ä½œ
                        notesDiv.appendChild(note);
                    }
                    cell.appendChild(notesDiv);
                    
                    // å‰µå»ºä¸»æ•¸å­—é¡¯ç¤ºå€åŸŸ
                    const numSpan = document.createElement('span');
                    numSpan.className = 'main-num';
                    cell.appendChild(numSpan);
                    
                    // æ·»åŠ é»æ“Šäº‹ä»¶ - é»æ“Šæ™‚é¸æ“‡è©²å–®å…ƒæ ¼
                    cell.addEventListener('click', () => selectCell(r, c));
                    boardEl.appendChild(cell);
                }
            }
        }

        /**
         * å‰µå»ºæ•¸å­—éµç›¤çš„HTMLçµæ§‹
         * åŒ…å«1-9çš„æ•¸å­—æŒ‰éˆ•ï¼Œç”¨æ–¼ç©å®¶è¼¸å…¥æ•¸å­—
         */
        function createKeypadHTML() {
            const keypad = document.getElementById('keypad');
            keypad.innerHTML = '';
            
            // å‰µå»º1-9çš„æ•¸å­—æŒ‰éˆ•
            for (let i = 1; i <= 9; i++) {
                const btn = document.createElement('div');
                btn.className = 'numpad-btn';
                btn.id = `btn-num-${i}`;
                btn.innerHTML = `<div class="num">${i}</div><div class="count">9</div>`;
                btn.addEventListener('click', () => handleInput(i));
                keypad.appendChild(btn);
            }
        }

        /**
         * é¸æ“‡å–®å…ƒæ ¼
         * @param {number} r - è¡Œç´¢å¼•
         * @param {number} c - åˆ—ç´¢å¼•
         * ç•¶ç©å®¶é»æ“Šå–®å…ƒæ ¼æ™‚ï¼Œå°‡å…¶è¨­ç½®ç‚ºç•¶å‰é¸ä¸­ç‹€æ…‹ä¸¦æ›´æ–°é«˜äº®é¡¯ç¤º
         */
        function selectCell(r, c) {
            // å¦‚æœéŠæˆ²çµæŸæˆ–æš«åœï¼Œä¸è™•ç†é¸æ“‡
            if (gameOver || isPaused) return;
            
            // è¨­ç½®ç•¶å‰é¸ä¸­çš„å–®å…ƒæ ¼
            selectedCell = { r, c };
            
            // æ›´æ–°é«˜äº®é¡¯ç¤º
            updateHighlighting();
            
            // æ’­æ”¾UIéŸ³æ•ˆ
            playSound('ui');
        }

        /**
         * è™•ç†æ•¸å­—è¼¸å…¥
         * @param {number} num - è¼¸å…¥çš„æ•¸å­—ï¼ˆ1-9ï¼‰
         * æ ¹æ“šç•¶å‰é¸ä¸­çš„å–®å…ƒæ ¼å’Œè¼¸å…¥çš„æ•¸å­—ï¼Œæ›´æ–°éŠæˆ²ç‹€æ…‹
         */
        function handleInput(num) {
            // å¦‚æœéŠæˆ²çµæŸã€æ²’æœ‰é¸ä¸­å–®å…ƒæ ¼æˆ–éŠæˆ²æš«åœï¼Œä¸è™•ç†è¼¸å…¥
            if (gameOver || !selectedCell || isPaused) return;
            
            const { r, c } = selectedCell;
            
            // å¦‚æœå–®å…ƒæ ¼æ˜¯åˆå§‹ç·šç´¢æˆ–å·²ç¶“æ­£ç¢ºå¡«å¯«ï¼Œä¸å…è¨±ä¿®æ”¹
            if (initial[r][c] !== 0 || (board[r][c] !== 0 && board[r][c] === solution[r][c])) return;
            
            const cellDiv = getCellDiv(r, c);
            
            // æª¢æŸ¥ç­”æ¡ˆæ˜¯å¦æ­£ç¢º
            if (num === solution[r][c]) {
                // æ­£ç¢ºç­”æ¡ˆ
                board[r][c] = num;
                playSound('correct');
                updateBoardUI();
                updateCounts();
                updateHighlighting();
                checkWin(); // æª¢æŸ¥æ˜¯å¦å®ŒæˆéŠæˆ²
            } else {
                // éŒ¯èª¤ç­”æ¡ˆ
                playSound('error');
                errorCount++;
                updateStats();
                
                // é¡¯ç¤ºéŒ¯èª¤å‹•ç•«
                cellDiv.querySelector('.main-num').innerText = num;
                cellDiv.classList.add('error');
                cellDiv.classList.add('filled');
                
                // 500æ¯«ç§’å¾Œæ¢å¾©æ­£å¸¸é¡¯ç¤º
                setTimeout(() => {
                    cellDiv.classList.remove('error');
                    cellDiv.querySelector('.main-num').innerText = board[r][c] === 0 ? '' : board[r][c];
                    cellDiv.classList.remove('filled');
                    if (notesEnabled) updateNotes();
                }, 500);
            }
        }

        /**
         * æ›´æ–°çµ±è¨ˆé¡¯ç¤º
         * æ›´æ–°éŒ¯èª¤æ¬¡æ•¸å’Œæç¤ºä½¿ç”¨æ¬¡æ•¸çš„é¡¯ç¤º
         */
        function updateStats() {
            // ä½¿ç”¨padStartç¡®ä¿ä¸¤ä½æ•°æ˜¾ç¤º
            document.getElementById('error-stat').innerText = errorCount.toString().padStart(2, '0');
            document.getElementById('hint-stat').innerText = hintCount.toString().padStart(2, '0');
        }

        /**
         * é–‹å§‹è¨ˆæ™‚å™¨
         * åˆå§‹åŒ–è¨ˆæ™‚å™¨ä¸¦æ¯ç§’æ›´æ–°æ™‚é–“é¡¯ç¤º
         */
        function startTimer() {
            stopTimer(); // åœæ­¢ç¾æœ‰è¨ˆæ™‚å™¨
            timeElapsed = 0;
            isPaused = false;
            updateTimerDisplay();
            
            // æ¯ç§’æ›´æ–°ä¸€æ¬¡æ™‚é–“é¡¯ç¤º
            timerInterval = setInterval(() => {
                if (!isPaused && !gameOver) {
                    timeElapsed++;
                    updateTimerDisplay();
                }
            }, 1000);
        }

        /**
         * åœæ­¢è¨ˆæ™‚å™¨
         * æ¸…é™¤è¨ˆæ™‚å™¨é–“éš”ï¼Œåœæ­¢è¨ˆæ™‚
         */
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        /**
         * æ›´æ–°æ™‚é–“é¡¯ç¤º
         * å°‡ç§’æ•¸è½‰æ›ç‚ºåˆ†:ç§’æ ¼å¼ä¸¦æ›´æ–°é¡¯ç¤º
         * @returns {string} æ ¼å¼åŒ–å¾Œçš„æ™‚é–“å­—ç¬¦ä¸²
         */
        function updateTimerDisplay() {
            const minutes = Math.floor(timeElapsed / 60);
            const seconds = timeElapsed % 60;
            const text = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            document.getElementById('timer-display').innerText = text;
            return text;
        }

        // ======================================================================
        // æ•¸ç¨ç”Ÿæˆèˆ‡é©—è­‰ç®—æ³•
        // ======================================================================

        /**
         * æ ¹æ“šé›£åº¦ç”Ÿæˆæ•¸ç¨éŠæˆ²
         * @param {string} difficulty - é›£åº¦ç´šåˆ¥ï¼š'Beginner', 'Easy', 'Medium', 'Hard', 'Expert'
         * ä½¿ç”¨å›æº¯ç®—æ³•ç”Ÿæˆå®Œæ•´è§£ç­”ï¼Œç„¶å¾Œæ ¹æ“šé›£åº¦ç§»é™¤ä¸€å®šæ•¸é‡çš„æ•¸å­—
         */
        function generateSudoku(difficulty) {
            // åˆå§‹åŒ–ç©ºç™½ç›¤é¢
            board = Array.from({ length: 9 }, () => Array(9).fill(0));
            
            // å…ˆå¡«å……å°è§’ç·šçš„ä¸‰å€‹3x3å®®æ ¼ï¼ˆé€™æ¨£å¯ä»¥ç¢ºä¿ä¸è¡çªï¼‰
            fillDiagonal();
            
            // ä½¿ç”¨å›æº¯ç®—æ³•è§£æ±ºå®Œæ•´çš„æ•¸ç¨
            solveSudoku(board);
            
            // ä¿å­˜å®Œæ•´è§£ç­”
            solution = JSON.parse(JSON.stringify(board));
            
            // æ ¹æ“šé›£åº¦æ±ºå®šç§»é™¤å¤šå°‘æ•¸å­—ï¼ˆæ•¸å­—è¶Šå°‘é›£åº¦è¶Šé«˜ï¼‰
            let attempts = 0;
            switch(difficulty) {
                case 'Beginner': attempts = 20; break; // å…¥é–€ - ç§»é™¤20å€‹æ•¸å­—
                case 'Easy': attempts = 30; break;     // ç°¡å–® - ç§»é™¤30å€‹æ•¸å­—
                case 'Medium': attempts = 40; break;   // ä¸­ç­‰ - ç§»é™¤40å€‹æ•¸å­—
                case 'Hard': attempts = 50; break;     // å›°é›£ - ç§»é™¤50å€‹æ•¸å­—
                case 'Expert': attempts = 58; break;   // å°ˆå®¶ - ç§»é™¤58å€‹æ•¸å­—
            }
            
            // ä¿å­˜åˆå§‹ç›¤é¢ï¼ˆåŒ…å«ç·šç´¢æ•¸å­—ï¼‰
            initial = JSON.parse(JSON.stringify(solution));
            
            // é‡ç½®ç©å®¶ç›¤é¢
            board = Array.from({ length: 9 }, () => Array(9).fill(0));
            
            // éš¨æ©Ÿç§»é™¤æŒ‡å®šæ•¸é‡çš„æ•¸å­—
            let removed = 0;
            while (removed < attempts) {
                let row = Math.floor(Math.random() * 9);
                let col = Math.floor(Math.random() * 9);
                
                // å¦‚æœè©²ä½ç½®æœ‰æ•¸å­—ï¼Œç§»é™¤å®ƒ
                if (initial[row][col] !== 0) {
                    initial[row][col] = 0;
                    removed++;
                }
            }
        }

        /**
         * å¡«å……å°è§’ç·šçš„ä¸‰å€‹3x3å®®æ ¼
         * é€™ä¸‰å€‹å®®æ ¼äº’ä¸å½±éŸ¿ï¼Œå¯ä»¥ç¨ç«‹å¡«å……ï¼Œç¢ºä¿åˆå§‹ç‹€æ…‹æœ‰æ•ˆ
         */
        function fillDiagonal() {
            for (let i = 0; i < 9; i += 3) {
                fillBox(i, i);
            }
        }

        /**
         * å¡«å……æŒ‡å®šçš„3x3å®®æ ¼
         * @param {number} row - å®®æ ¼èµ·å§‹è¡Œ
         * @param {number} col - å®®æ ¼èµ·å§‹åˆ—
         * éš¨æ©Ÿç”Ÿæˆæ•¸å­—å¡«å……3x3å®®æ ¼ï¼Œç¢ºä¿å®®æ ¼å…§æ•¸å­—ä¸é‡è¤‡
         */
        function fillBox(row, col) {
            let num;
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    // éš¨æ©Ÿç”Ÿæˆæ•¸å­—ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€å€‹å¯ç”¨çš„
                    do {
                        num = Math.floor(Math.random() * 9) + 1;
                    } while (!isSafeInBox(row, col, num));
                    
                    board[row + i][col + j] = num;
                }
            }
        }

        /**
         * æª¢æŸ¥æ•¸å­—åœ¨æŒ‡å®š3x3å®®æ ¼ä¸­æ˜¯å¦å®‰å…¨ï¼ˆä¸é‡è¤‡ï¼‰
         * @param {number} rowStart - å®®æ ¼èµ·å§‹è¡Œ
         * @param {number} colStart - å®®æ ¼èµ·å§‹åˆ—
         * @param {number} num - è¦æª¢æŸ¥çš„æ•¸å­—
         * @returns {boolean} æ˜¯å¦å®‰å…¨
         */
        function isSafeInBox(rowStart, colStart, num) {
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    if (board[rowStart + i][colStart + j] === num) return false;
                }
            }
            return true;
        }

        /**
         * ä½¿ç”¨å›æº¯ç®—æ³•è§£æ±ºæ•¸ç¨
         * @param {Array} grid - æ•¸ç¨ç›¤é¢
         * @returns {boolean} æ˜¯å¦æˆåŠŸè§£æ±º
         * é€™æ˜¯ç¶“å…¸çš„å›æº¯ç®—æ³•å¯¦ç¾ï¼Œç”¨æ–¼ç”Ÿæˆæ•¸ç¨è§£ç­”
         */
        function solveSudoku(grid) {
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    // æ‰¾åˆ°ç©ºç™½å–®å…ƒæ ¼
                    if (grid[row][col] === 0) {
                        // å˜—è©¦1-9çš„æ•¸å­—
                        for (let num = 1; num <= 9; num++) {
                            // æª¢æŸ¥æ•¸å­—æ˜¯å¦å®‰å…¨
                            if (isSafe(grid, row, col, num)) {
                                // æ”¾ç½®æ•¸å­—
                                grid[row][col] = num;
                                
                                // éæ­¸å˜—è©¦è§£æ±ºå‰©ä¸‹çš„ç›¤é¢
                                if (solveSudoku(grid)) return true;
                                
                                // å¦‚æœéæ­¸å¤±æ•—ï¼Œå›æº¯ï¼ˆé‡ç½®å–®å…ƒæ ¼ï¼‰
                                grid[row][col] = 0;
                            }
                        }
                        // å¦‚æœæ‰€æœ‰æ•¸å­—éƒ½å˜—è©¦éä½†éƒ½ä¸è¡Œï¼Œè¿”å›å¤±æ•—
                        return false;
                    }
                }
            }
            // æ‰€æœ‰å–®å…ƒæ ¼éƒ½å·²å¡«æ»¿ï¼Œè§£æ±ºæˆåŠŸ
            return true;
        }

        /**
         * æª¢æŸ¥æ•¸å­—åœ¨æŒ‡å®šä½ç½®æ˜¯å¦å®‰å…¨
         * @param {Array} grid - æ•¸ç¨ç›¤é¢
         * @param {number} row - è¡Œç´¢å¼•
         * @param {number} col - åˆ—ç´¢å¼•
         * @param {number} num - è¦æª¢æŸ¥çš„æ•¸å­—
         * @returns {boolean} æ˜¯å¦å®‰å…¨
         * æª¢æŸ¥è¡Œã€åˆ—å’Œ3x3å®®æ ¼ä¸­æ˜¯å¦æœ‰é‡è¤‡æ•¸å­—
         */
        function isSafe(grid, row, col, num) {
            // æª¢æŸ¥è¡Œå’Œåˆ—
            for (let x = 0; x < 9; x++) {
                if (grid[row][x] === num || grid[x][col] === num) return false;
            }
            
            // æª¢æŸ¥3x3å®®æ ¼
            let startRow = row - row % 3;
            let startCol = col - col % 3;
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    if (grid[i + startRow][j + startCol] === num) return false;
                }
            }
            return true;
        }

        /**
         * ä½¿ç”¨æç¤ºåŠŸèƒ½ï¼ˆè‡ªå‹•å¡«å…¥ä¸€å€‹æ­£ç¢ºæ•¸å­—ï¼‰
         * éš¨æ©Ÿé¸æ“‡ä¸€å€‹ç©ºç™½å–®å…ƒæ ¼ä¸¦å¡«å…¥æ­£ç¢ºç­”æ¡ˆ
         */
        function useHint() {
            // å¦‚æœéŠæˆ²çµæŸæˆ–æš«åœï¼Œä¸æä¾›æç¤º
            if (gameOver || isPaused) return;
            
            // æ”¶é›†æ‰€æœ‰ç©ºç™½å–®å…ƒæ ¼
            const emptyCells = [];
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    if (board[r][c] === 0 && initial[r][c] === 0) {
                        emptyCells.push({r, c});
                    }
                }
            }
            
            // å¦‚æœæ²’æœ‰ç©ºç™½å–®å…ƒæ ¼ï¼Œç›´æ¥è¿”å›
            if (emptyCells.length === 0) return;
            
            // å¢åŠ æç¤ºè¨ˆæ•¸ä¸¦æ›´æ–°é¡¯ç¤º
            hintCount++;
            updateStats();
            
            // éš¨æ©Ÿé¸æ“‡ä¸€å€‹ç©ºç™½å–®å…ƒæ ¼
            const { r, c } = emptyCells[Math.floor(Math.random() * emptyCells.length)];
            
            // å¡«å…¥æ­£ç¢ºç­”æ¡ˆ
            board[r][c] = solution[r][c];
            updateBoardUI();
            
            // æ·»åŠ æç¤ºå‹•ç•«æ•ˆæœ
            const cellDiv = getCellDiv(r, c);
            cellDiv.classList.add('hinting');
            setTimeout(() => {
                if (cellDiv) cellDiv.classList.remove('hinting');
            }, 2000);
            
            // æ’­æ”¾æç¤ºéŸ³æ•ˆ
            playSound('hint');
            
            // æ›´æ–°UI
            updateCounts();
            updateHighlighting();
            
            // æª¢æŸ¥æ˜¯å¦å®ŒæˆéŠæˆ²
            checkWin();
        }

        /**
         * ç²å–æŒ‡å®šå–®å…ƒæ ¼çš„DOMå…ƒç´ 
         * @param {number} r - è¡Œç´¢å¼•
         * @param {number} c - åˆ—ç´¢å¼•
         * @returns {HTMLElement} å–®å…ƒæ ¼DOMå…ƒç´ 
         */
        function getCellDiv(r, c) {
            return document.querySelector(`.cell[data-r='${r}'][data-c='${c}']`);
        }

        /**
         * æ›´æ–°æ•¸ç¨ç›¤é¢UI
         * æ ¹æ“šç•¶å‰éŠæˆ²ç‹€æ…‹æ›´æ–°æ‰€æœ‰å–®å…ƒæ ¼çš„é¡¯ç¤º
         */
        function updateBoardUI() {
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    const cell = getCellDiv(r, c);
                    
                    // ç²å–å–®å…ƒæ ¼çš„å€¼ï¼ˆç©å®¶è¼¸å…¥æˆ–åˆå§‹ç·šç´¢ï¼‰
                    const val = board[r][c] !== 0 ? board[r][c] : initial[r][c];
                    
                    // æ›´æ–°ä¸»æ•¸å­—é¡¯ç¤º
                    cell.querySelector('.main-num').innerText = val === 0 ? '' : val;
                    
                    // é‡ç½®å–®å…ƒæ ¼é¡
                    cell.className = 'cell';
                    
                    // æ·»åŠ 3x3å®®æ ¼é‚Šæ¡†
                    if ((c + 1) % 3 === 0 && c !== 8) cell.classList.add('border-right');
                    if ((r + 1) % 3 === 0 && r !== 8) cell.classList.add('border-bottom');
                    
                    // è¨­ç½®å–®å…ƒæ ¼é¡å‹
                    if (initial[r][c] !== 0) {
                        cell.classList.add('clue'); // åˆå§‹ç·šç´¢
                    } else if (board[r][c] !== 0) {
                        cell.classList.add('filled'); // ç©å®¶å¡«å¯«çš„æ•¸å­—
                    }
                }
            }
            
            // å¦‚æœç­†è¨˜æ¨¡å¼å•Ÿç”¨ï¼Œæ›´æ–°ç­†è¨˜é¡¯ç¤º
            if (notesEnabled) updateNotes();
            else clearNotes();
        }

        /**
         * åˆ‡æ›ç­†è¨˜æ¨¡å¼
         * ç­†è¨˜æ¨¡å¼å…è¨±ç©å®¶åœ¨å–®å…ƒæ ¼ä¸­æ¨™è¨˜å€™é¸æ•¸å­—
         */
        function toggleNotes() {
            if (isPaused) return;
            
            // åˆ‡æ›ç­†è¨˜æ¨¡å¼ç‹€æ…‹
            notesEnabled = !notesEnabled;
            
            // æ›´æ–°æŒ‰éˆ•é¡è‰²
            const notesBtn = document.getElementById('btn-notes');
            if (notesEnabled) {
                notesBtn.classList.add('btn-on');
                notesBtn.classList.remove('btn-secondary');
            } else {
                notesBtn.classList.remove('btn-on');
                notesBtn.classList.add('btn-secondary');
            }
            
            // æ›´æ–°ç­†è¨˜é¡¯ç¤º
            if (notesEnabled) updateNotes();
            else clearNotes();
            
            // æ›´æ–°é«˜äº®é¡¯ç¤º
            updateHighlighting();
        }

        /**
         * æ¸…é™¤æ‰€æœ‰ç­†è¨˜
         * æ¸…ç©ºæ‰€æœ‰å–®å…ƒæ ¼ä¸­çš„å€™é¸æ•¸å­—é¡¯ç¤º
         */
        function clearNotes() {
            document.querySelectorAll('.note-num').forEach(el => el.innerText = '');
        }

        /**
         * æ›´æ–°ç­†è¨˜é¡¯ç¤º
         * é¡¯ç¤ºæ¯å€‹ç©ºç™½å–®å…ƒæ ¼ä¸­å¯èƒ½çš„å€™é¸æ•¸å­—
         * å€™é¸æ•¸å­—æ˜¯æ ¹æ“šç•¶å‰ç›¤é¢ç‹€æ…‹è¨ˆç®—å¾—å‡ºçš„å¯èƒ½æ­£ç¢ºçš„æ•¸å­—
         */
        function updateNotes() {
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    const cell = getCellDiv(r, c);
                    const noteContainer = cell.querySelector('.notes-grid');
                    
                    // æ¸…ç©ºç¾æœ‰ç­†è¨˜
                    noteContainer.querySelectorAll('.note-num').forEach(n => n.innerText = '');
                    
                    // å¦‚æœæ˜¯ç©ºç™½å–®å…ƒæ ¼ï¼Œè¨ˆç®—ä¸¦é¡¯ç¤ºå€™é¸æ•¸å­—
                    if (board[r][c] === 0 && initial[r][c] === 0) {
                        // åˆä½µåˆå§‹ç›¤é¢å’Œç©å®¶è¼¸å…¥ï¼Œç”¨æ–¼æª¢æŸ¥å€™é¸æ•¸å­—
                        let combinedGrid = JSON.parse(JSON.stringify(initial));
                        for (let i = 0; i < 9; i++) {
                            for (let j = 0; j < 9; j++) {
                                if (board[i][j] !== 0) combinedGrid[i][j] = board[i][j];
                            }
                        }
                        
                        // æª¢æŸ¥æ¯å€‹æ•¸å­—æ˜¯å¦å¯å®‰å…¨å¡«å…¥
                        for (let n = 1; n <= 9; n++) {
                            if (isSafe(combinedGrid, r, c, n)) {
                                noteContainer.querySelector(`.note-num[data-num='${n}']`).innerText = n;
                            }
                        }
                    }
                }
            }
        }

        /**
         * æ›´æ–°é«˜äº®é¡¯ç¤º
         * é«˜äº®ç›¸é—œå–®å…ƒæ ¼ï¼ˆåŒä¸€è¡Œã€åˆ—å’Œå®®æ ¼ï¼‰å’Œç›¸åŒæ•¸å­—
         * ç•¶é¸ä¸­ä¸€å€‹å–®å…ƒæ ¼æ™‚ï¼Œçªå‡ºé¡¯ç¤ºæ‰€æœ‰ç›¸é—œå–®å…ƒæ ¼å’Œç›¸åŒæ•¸å­—çš„å–®å…ƒæ ¼
         */
        function updateHighlighting() {
            // æ¸…é™¤æ‰€æœ‰é«˜äº®
            document.querySelectorAll('.cell').forEach(c => {
                c.classList.remove('selected', 'highlight-related', 'highlight-same');
            });
            
            document.querySelectorAll('.note-num').forEach(n => {
                n.classList.remove('highlighted');
            });
            
            document.querySelectorAll('.numpad-btn').forEach(b => {
                b.classList.remove('suggested');
            });
            
            // å¦‚æœæ²’æœ‰é¸ä¸­å–®å…ƒæ ¼ï¼Œç›´æ¥è¿”å›
            if (!selectedCell) return;
            
            const { r, c } = selectedCell;
            
            // ç²å–ç•¶å‰é¸ä¸­å–®å…ƒæ ¼çš„å€¼
            const val = board[r][c] !== 0 ? board[r][c] : initial[r][c];
            
            // è¨ˆç®—ç•¶å‰å–®å…ƒæ ¼æ‰€åœ¨çš„3x3å®®æ ¼èµ·å§‹ä½ç½®
            const startRow = r - r % 3;
            const startCol = c - c % 3;
            
            // é«˜äº®åŒä¸€è¡Œå’ŒåŒä¸€åˆ—çš„å–®å…ƒæ ¼
            for (let i = 0; i < 9; i++) {
                getCellDiv(r, i).classList.add('highlight-related');
                getCellDiv(i, c).classList.add('highlight-related');
            }
            
            // é«˜äº®åŒä¸€3x3å®®æ ¼çš„å–®å…ƒæ ¼
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    getCellDiv(startRow + i, startCol + j).classList.add('highlight-related');
                }
            }
            
            // é«˜äº®é¸ä¸­çš„å–®å…ƒæ ¼
            getCellDiv(r, c).classList.add('selected');
            
            // å¦‚æœé¸ä¸­çš„å–®å…ƒæ ¼æœ‰æ•¸å­—ï¼Œé«˜äº®æ‰€æœ‰ç›¸åŒæ•¸å­—çš„å–®å…ƒæ ¼
            if (val !== 0) {
                for (let i = 0; i < 9; i++) {
                    for (let j = 0; j < 9; j++) {
                        const cellVal = board[i][j] !== 0 ? board[i][j] : initial[i][j];
                        if (cellVal === val) {
                            getCellDiv(i, j).classList.add('highlight-same');
                        }
                    }
                }
                
                // å¦‚æœç­†è¨˜æ¨¡å¼å•Ÿç”¨ï¼Œé«˜äº®ç­†è¨˜ä¸­çš„ç›¸åŒæ•¸å­—
                if (notesEnabled) {
                    document.querySelectorAll(`.note-num[data-num='${val}']`).forEach(noteEl => {
                        if (noteEl.innerText === String(val)) {
                            noteEl.classList.add('highlighted');
                        }
                    });
                }
            }
            
            // åƒ…åœ¨é¸ä¸­å–®å…ƒæ ¼ç‚ºç©ºç™½æ™‚æª¢æŸ¥ä¸¦çªå‡ºé¡¯ç¤ºå»ºè­°æ•¸å­—
            if (board[r][c] === 0 && initial[r][c] === 0) {
                checkGroupAndHighlight(r, c);
            }
        }

        /**
         * æª¢æŸ¥è¡Œã€åˆ—æˆ–å®®æ˜¯å¦å·²å¡«å…¥8å€‹æ•¸å­—ï¼Œå¦‚æœæ˜¯å‰‡çªå‡ºé¡¯ç¤ºç­”æ¡ˆ
         * åƒ…ç•¶é¸ä¸­å–®å…ƒæ ¼ç‚ºç©ºç™½ä¸”æ˜¯å”¯ä¸€ç¼ºå¤±çš„æ•¸å­—æ™‚æ‰çªå‡ºé¡¯ç¤º
         * @param {number} r - è¡Œç´¢å¼•
         * @param {number} c - åˆ—ç´¢å¼•
         */
        function checkGroupAndHighlight(r, c) {
            // æª¢æŸ¥è¡Œ
            let rowValues = [];
            for (let i = 0; i < 9; i++) {
                const val = board[r][i] !== 0 ? board[r][i] : initial[r][i];
                rowValues.push(val);
            }
            let rowMissing = findMissingNumber(rowValues);
            if (rowMissing !== -1) {
                highlightSuggestedNumber(rowMissing);
                return;
            }
            
            // æª¢æŸ¥åˆ—
            let colValues = [];
            for (let i = 0; i < 9; i++) {
                const val = board[i][c] !== 0 ? board[i][c] : initial[i][c];
                colValues.push(val);
            }
            let colMissing = findMissingNumber(colValues);
            if (colMissing !== -1) {
                highlightSuggestedNumber(colMissing);
                return;
            }
            
            // æª¢æŸ¥å®®
            let boxValues = [];
            const startRow = r - r % 3;
            const startCol = c - c % 3;
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    const val = board[startRow + i][startCol + j] !== 0 ? 
                                board[startRow + i][startCol + j] : 
                                initial[startRow + i][startCol + j];
                    boxValues.push(val);
                }
            }
            let boxMissing = findMissingNumber(boxValues);
            if (boxMissing !== -1) {
                highlightSuggestedNumber(boxMissing);
                return;
            }
        }

        /**
         * åœ¨æ•¸å­—çµ„ä¸­æŸ¥æ‰¾ç¼ºå¤±çš„æ•¸å­—
         * @param {Array} values - æ•¸å­—çµ„
         * @returns {number} ç¼ºå¤±çš„æ•¸å­—ï¼Œå¦‚æœæ²’æœ‰æˆ–æœ‰å¤šå€‹ç¼ºå¤±å‰‡è¿”å›-1
         */
        function findMissingNumber(values) {
            let missing = 0;
            let count = 0;
            for (let i = 1; i <= 9; i++) {
                if (!values.includes(i)) {
                    missing = i;
                    count++;
                }
            }
            return count === 1 ? missing : -1;
        }

        /**
         * çªå‡ºé¡¯ç¤ºå»ºè­°çš„æ•¸å­—
         * @param {number} num - è¦çªå‡ºé¡¯ç¤ºçš„æ•¸å­—
         */
        function highlightSuggestedNumber(num) {
            const btn = document.getElementById(`btn-num-${num}`);
            if (btn) {
                btn.classList.add('suggested');
            }
        }

        /**
         * æ›´æ–°æ•¸å­—çµ±è¨ˆ
         * é¡¯ç¤ºæ¯å€‹æ•¸å­—é‚„éœ€è¦å¡«å¯«çš„æ•¸é‡
         * ç•¶æ•¸å­—å·²å®Œæˆæ™‚ï¼Œå°‡å°æ‡‰çš„æ•¸å­—æŒ‰éˆ•è®Šæ·¡
         */
        function updateCounts() {
            // é‡ç½®è¨ˆæ•¸å™¨
            counts.fill(9);
            
            // çµ±è¨ˆå·²å¡«å¯«çš„æ•¸å­—
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    const val = board[r][c] !== 0 ? board[r][c] : initial[r][c];
                    if (val !== 0) counts[val]--;
                }
            }
            
            // æ›´æ–°æ•¸å­—éµç›¤é¡¯ç¤º
            for (let i = 1; i <= 9; i++) {
                const btn = document.getElementById(`btn-num-${i}`);
                btn.querySelector('.count').innerText = counts[i];
                
                // å¦‚æœæ•¸å­—å·²å®Œæˆï¼Œå°‡æŒ‰éˆ•è®Šæ·¡
                if (counts[i] <= 0) {
                    btn.classList.add('faded');
                } else {
                    btn.classList.remove('faded');
                }
            }
        }

        /**
         * æª¢æŸ¥éŠæˆ²æ˜¯å¦å®Œæˆ
         * æ¯”è¼ƒç•¶å‰ç›¤é¢èˆ‡è§£ç­”ï¼Œå¦‚æœå®Œå…¨ç›¸åŒå‰‡éŠæˆ²å®Œæˆ
         */
        function checkWin() {
            let isFull = true;
            
            // æª¢æŸ¥æ¯å€‹å–®å…ƒæ ¼æ˜¯å¦æ­£ç¢ºå¡«å¯«
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    const cellVal = board[r][c] !== 0 ? board[r][c] : initial[r][c];
                    if (cellVal !== solution[r][c]) {
                        isFull = false;
                        break;
                    }
                }
                if (!isFull) break;
            }
            
            // å¦‚æœæ‰€æœ‰å–®å…ƒæ ¼éƒ½æ­£ç¢ºï¼Œé¡¯ç¤ºå‹åˆ©ç•Œé¢
            if (isFull) {
                gameOver = true;
                stopTimer();
                playSound('win');
                
                // æ›´æ–°å‹åˆ©ç•Œé¢ä¿¡æ¯
                document.getElementById('victory-time-text').innerText = `è€—æ™‚ï¼š${updateTimerDisplay()}`;
                document.getElementById('victory-stats').innerText = `éŒ¯èª¤: ${errorCount.toString().padStart(2, '0')}, æç¤º: ${hintCount.toString().padStart(2, '0')}`;
                document.getElementById('victory-overlay').style.display = 'flex';
                
                // æ¸…é™¤æ‰€æœ‰é«˜äº®
                document.querySelectorAll('.cell').forEach(c => {
                    c.classList.remove('selected', 'highlight-related', 'highlight-same');
                });
            }
        }

        /**
         * é—œé–‰å‹åˆ©ç•Œé¢
         * éš±è—å‹åˆ©å½ˆçª—ï¼Œè¿”å›éŠæˆ²ç•Œé¢
         */
        function closeOverlay() {
            document.getElementById('victory-overlay').style.display = 'none';
        }

        /**
         * åˆ‡æ›éŸ³æ•ˆé–‹é—œ
         * é–‹å•Ÿæˆ–é—œé–‰éŠæˆ²éŸ³æ•ˆ
         */
        function toggleSound() {
            // åˆ‡æ›éŸ³æ•ˆç‹€æ…‹
            soundEnabled = !soundEnabled;
            
            // æ›´æ–°æŒ‰éˆ•é¡è‰²
            const soundBtn = document.getElementById('btn-sound');
            if (soundEnabled) {
                soundBtn.classList.add('btn-on');
                soundBtn.classList.remove('btn-secondary');
            } else {
                soundBtn.classList.remove('btn-on');
                soundBtn.classList.add('btn-secondary');
            }
        }
    </script>
</body>
</html>